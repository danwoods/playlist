/*! playlist - v0.0.0-30 - 2013-03-08 */
var API=function(){var e=this,t=function(e,t,n,r){t&&t.id&&localStorage.getItem(t.id)?(data=JSON.parse(localStorage.getItem(t.id)),r&&r(data)):$.getJSON(e,function(e){t&&(e=_.where(e[n],t),t.id&&e.length===1&&(e=e[0],localStorage.setItem(t.id,JSON.stringify(e)))),r&&r(e)})};this.getArtists=function(e,n){t("/artist",e,"artist",n)},this.getAlbums=function(e,n){t("/artist/"+e.artist_id+"/album",e,"album",n)},this.getSongs=function(e,n){t("/song",e,"song",n)},this.buildSong=function(t,n){var r={};e.getSongs({id:t},function(t){r=t,e.getAlbums({id:r.album_id},function(t){r.album=t,e.getArtists({id:r.album.artist_id},function(e){r.album.artist=e,n&&n(r)})})})},this.buildSongsFromAlbum=function(t,n){var r={};e.getAlbums({id:t},function(t){r.album=t,e.getArtists({id:t.artist_id},function(t){r.album.artist=t,e.getSongs({album_id:r.album.id},function(e){n&&n(_.map(e,function(e){return _.defaults(e,r)}))})})})},this.buildSongsFromArtist=function(n,r){var i={},s={},o=0,u=[];e.getArtists({id:n},function(n){n=n,e.getAlbums({artist_id:n.id},function(e){o=_.map(e,function(e){return e.song_ids.length}).length;for(var i=0;i<e.length;i++)s.album=e[i],s.album.artist=n,t("/album/"+s.album.name.replace(/ /g,"_")+"/song",null,null,function(e){u=u.concat(_.flatten(_.map(e.song,function(e){return _.defaults(e,s)}))),u.length>=o&&r&&r(u)})})})}},Catalog=function(e){var t=this,n=new API;t.elm=e,t.$elm=jQuery(e);var r=function(e){var t={id:e.target.getAttribute("data-id"),type:e.target.getAttribute("data-type"),name:$(e.target).find(".name").text()};e.dataTransfer.setData("text/plain",JSON.stringify(t))},i=function(e){var t=e[0].resource.toLowerCase(),n=$('<ol class="'+t+'s" />');return $.each(e,function(e,i){var s=$('<li id="'+i.id+'" class="'+t+'" data-id="'+i.id+'" data-type="'+t+'" draggable="true"><span class="icon"></span><span class="name">'+i.name+"</span></li>");s.get()[0].addEventListener("dragstart",r,!1),n.append(s)}),n};t.$elm.on("click","ol > li.artist > span",function(){var e=$(this).parent(".artist");return e.hasClass("expanded")?e.removeClass("expanded"):e.children("ol").length===0?o(e,{artist_id:e.attr("id")}):e.addClass("expanded"),!1}),t.$elm.on("click","ol > li.album > span",function(){var e=$(this).parent(".album");return e.hasClass("expanded")?e.removeClass("expanded"):e.children("ol").length===0?s(e,{album_id:e.attr("id")}):e.addClass("expanded"),!1});var s=function(e,t,r){n.getSongs({album_id:e.attr("id")},function(t){e.append(i(t.song||t)).addClass("expanded")})},o=function(e,t){n.getAlbums(t,function(t){e.append(i(t.album||t)).addClass("expanded")})},u=function(e,t){n.getArtists(t,function(t){e.append(i(t.artist||t)).addClass("expanded")})};$("document").ready(function(){u(t.$elm)})},Playlist=function(e){var t=new API,n=this,r=function(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1},i=function(e){e.stopPropagation&&e.stopPropagation();var n=JSON.parse(e.dataTransfer.getData("text/plain"));return n.type==="song"?t.buildSong(n.id,function(e){o(e)}):n.type==="album"?t.buildSongsFromAlbum(n.id,function(e){for(var t=0;t<e.length;t++)o(e[t])}):n.type==="artist"&&t.buildSongsFromArtist(n.id,function(e){for(var t=0;t<e.length;t++)o(e[t])}),!1},s=function(t){var n=function(e){$(".song").removeClass("dodge");var t=$(e.target);t.hasClass("song")?t.addClass("dodge"):t.parents(".song").addClass("dodge")},r=function(e){var t=$(e.target);t.hasClass("song")?t.removeClass("dodge"):t.parents(".song").removeClass("dodge")},i=function(t){$(e).trigger("drop",t)},s=function(){var e=$("<li />"),s=t.name||"unknown song name",o=t.album.name||"unknown album",u=t.album.artist.name||"unknown artist",a=t.length||"unknown length";return e.addClass("song"),e.attr("id",_.uniqueId("pl-")),e.attr("data-id",t.id),e.append('<span class="song-name" title="'+s+'">'+s+"</span>"),e.append('<span class="song-album" title="'+o+'">'+o+"</span>"),e.append('<span class="song-artist" title="'+u+'">'+u+"</span>"),e.append('<span class="song-time" title="'+a+'">'+a+"</span>"),e.get()[0].addEventListener("dragenter",n,!0),e.get()[0].addEventListener("dragleave",r,!0),e.get()[0].addEventListener("drop",i,!0),e},o=s();return o},o=function(t){var n=s(t),r;$(e+" .song").length?(r=$(e+" .song")[0],$(e+" .song").each(function(){if($(this).hasClass("dodge"))return r=$(this),!1}),$(r).hasClass("dodge")?n.insertBefore(r):n.insertAfter(r)):$(e+" ol").append(n),$(e+" .song").removeClass("dodge")};this.getSongs=function(){var t=[];return t=_.map($(e).find(".song"),function(e){var t=$(e);return{song_id:t.attr("data-id"),elm_id:t.attr("id"),playing:t.hasClass("playing")}}),t},this.getNextSong=function(e){var r=n.getSongs(),i=0,s=r[0];for(i;i<r.length-1;i++)if(r[i].playing===!0){s=r[i+1];break}t.getSongs({id:s.song_id},function(n){n.elm_id=s.elm_id,t.getAlbums({id:n.album_id},function(r){n.album=r,t.getArtists({id:n.album.artist_id},function(t){n.artist=t,e&&e(n)})})})},this.getPrevSong=function(e){var r=n.getSongs(),i=1,s=r[0];for(i;i<r.length;i++)if(r[i].playing===!0){s=r[i-1];break}t.getSongs({id:s.song_id},function(n){n.elm_id=s.elm_id,t.getAlbums({id:n.album_id},function(r){n.album=r,t.getArtists({id:n.album.artist_id},function(t){n.artist=t,e&&e(n)})})})};var u=function(){$("document").ready(function(){$(e).get()[0].addEventListener("dragover",r,!1),$(e).get()[0].addEventListener("drop",i,!1),$(e).append('<ol dropzone="copy string:text/x-example" data-blankslate="Drop Artists/Albums/Songs here"/>')})};u()};